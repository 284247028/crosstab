<!DOCTYPE html>
<html>
    <head>
        <title>Crosstab Mocha Tests</title>
        <meta charset="utf=8">
        <script>
            localStorage.clear();
        </script>
        <link rel="stylesheet" href="../node_modules/mocha/mocha.css" />
    </head>
    <body>
        <div id="mocha"></div>
        <script src="../node_modules/mocha/mocha.js"></script>
        <script src="../node_modules/expect.js/index.js"></script>
        <script>
          mocha.ui('bdd');
          mocha.reporter('html');
        </script>
        <script src="/src/crosstab.js"></script>
        <script id="crosstab" src="/test/test-crosstab.js"></script>
        <script>
            onload = function(){
                if (window.mochaPhantomJS) {
                    mochaPhantomJS.run();
                } else {
                    //mocha.checkLeaks();
                    //mocha.globals(['foo']);
                    var runner = mocha.run();

                    var failedTests = [];
                    runner.on('end', function(){
                            window.mochaResults = runner.stats;
                            window.mochaResults.reports = failedTests;
                            });

                    runner.on('fail', logFailure);

                    function logFailure(test, err){

                        var flattenTitles = function(test){
                            var titles = [];
                            while (test.parent.title){
                                titles.push(test.parent.title);
                                test = test.parent;
                            }
                            return titles.reverse();
                        };

                        failedTests.push({name: test.title, result: false, message: err.message, stack: err.stack, titles: flattenTitles(test) });
                    };
                }
            };
        </script>
    </body>
</html>
